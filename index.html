<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>POOL Token Presale</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f172a; /* آبی تیره */
            color: white;
            padding: 0;
            margin: 0;
        }
        header {
            display: flex;
            justify-content: flex-end;
            padding: 15px 20px;
            background: #1e293b; /* آبی تیره‌تر */
            box-shadow: 0px 2px 6px rgba(0,0,0,0.4);
        }
        header button {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            background: #2563eb; /* آبی روشن‌تر */
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        header button:hover {
            background: #1d4ed8;
        }
        main {
            text-align: center;
            padding: 40px 20px;
        }
        .card {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            display: inline-block;
            min-width: 300px;
            box-shadow: 0px 2px 10px rgba(0,0,0,0.5);
        }
        input {
            padding: 8px;
            width: 140px;
            font-size: 14px;
            margin-top: 10px;
            border-radius: 4px;
            border: none;
        }
        button {
            padding: 10px 18px;
            font-size: 16px;
            border: none;
            background: #2563eb;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #1d4ed8;
        }
        p {
            margin: 6px 0;
        }
    </style>
</head>
<body>

<header>
    <button onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
</header>

<main>
    <div class="card">
        <h2>POOL Token Presale</h2>
        <p id="walletAddress">Wallet: Not connected</p>
        <p id="userBalance">Your POOL Balance: 0</p>
        <p id="contractBalance">Tokens Left in Presale: 0</p>
        <p id="rateInfo">Rate: Loading...</p>

        <input type="number" id="ethAmount" placeholder="ETH amount" min="0.02" step="0.001">
        <br>
        <button onclick="buyTokens()">Buy Tokens</button>
        <p id="status"></p>
    </div>
</main>

<script>
const contractAddress = "0x7a1Ed548e5407Ec09937e467A90ca2Bc72A943E1";
const tokenAddress = "0xd8b10C6D44F0A37aeE038B75C59d72a0634840E7";

const abi = [
    {"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amountTokens","type":"uint256"}],"name":"TokensPurchased","type":"event"},
    {"inputs":[],"name":"buyTokens","outputs":[],"stateMutability":"payable","type":"function"},
    {"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"TOKENS_PER_ETHER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
];

let provider, signer, presaleContract, tokenContract, userAddress;

async function connectWallet() {
    if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("walletAddress").innerText = `Wallet: ${userAddress}`;
        document.getElementById("connectBtn").innerText = "Connected";

        presaleContract = new ethers.Contract(contractAddress, abi, signer);

        await loadBalances();
        await loadRate();
    } else {
        alert("Please install MetaMask!");
    }
}

async function loadRate() {
    try {
        const tokensPerEther = await presaleContract.TOKENS_PER_ETHER();
        const decimals = await getTokenDecimals();
        const formattedRate = ethers.utils.formatUnits(tokensPerEther, decimals);
        document.getElementById("rateInfo").innerText =
            `Rate: 1 ETH = ${formattedRate} POOL`;
    } catch (err) {
        console.error(err);
        document.getElementById("rateInfo").innerText = "Rate: Error loading";
    }
}

async function getTokenDecimals() {
    const tokenAbi = [
        "function decimals() view returns (uint8)"
    ];
    tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);
    return await tokenContract.decimals();
}

async function loadBalances() {
    const tokenAbi = [
        "function balanceOf(address) view returns (uint256)",
        "function decimals() view returns (uint8)"
    ];
    tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);

    const decimals = await tokenContract.decimals();
    const userBal = await tokenContract.balanceOf(userAddress);
    document.getElementById("userBalance").innerText =
        `Your POOL Balance: ${ethers.utils.formatUnits(userBal, decimals)}`;

    const contractBal = await tokenContract.balanceOf(contractAddress);
    document.getElementById("contractBalance").innerText =
        `Tokens Left in Presale: ${ethers.utils.formatUnits(contractBal, decimals)}`;
}

async function buyTokens() {
    const ethAmount = document.getElementById("ethAmount").value;
    if (ethAmount < 0.02) {
        alert("Minimum purchase is 0.02 ETH");
        return;
    }
    try {
        const tx = await presaleContract.buyTokens({ value: ethers.utils.parseEther(ethAmount) });
        document.getElementById("status").innerText = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        document.getElementById("status").innerText = "Purchase successful!";
        await loadBalances();
    } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Transaction failed!";
    }
}
</script>

</body>
</html>
