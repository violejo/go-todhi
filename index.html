<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>POOL Token Presale</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        body {
            font-family: 'Poppins', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            padding: 15px 30px;
            background: #1e293b;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header button {
            background: linear-gradient(270deg, #2563eb, #1d4ed8, #3b82f6);
            background-size: 600% 600%;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 0 10px #2563ebaa;
            transition: background-position 3s ease infinite;
            animation: gradientShift 8s ease infinite;
        }
        header button:hover {
            background-position: 100% 0;
            box-shadow: 0 0 20px #3b82f6cc;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        main {
            flex: 1;
            width: 100%;
            max-width: 420px;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card {
            background: #152238;
            padding: 35px 30px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.6);
            text-align: center;
            width: 100%;
        }

        h2 {
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 28px;
            letter-spacing: 1.2px;
            color: #60a5fa;
            text-shadow: 0 0 8px #3b82f6aa;
        }

        p {
            margin: 12px 0;
            font-weight: 500;
            font-size: 16px;
            color: #cbd5e1;
            user-select: none;
        }

        input[type=number] {
            width: 180px;
            padding: 12px 15px;
            margin-top: 15px;
            font-size: 16px;
            border-radius: 12px;
            border: none;
            outline: none;
            background: #1e293b;
            color: white;
            box-shadow: inset 0 0 5px #2563ebaa;
            transition: box-shadow 0.3s ease;
        }
        input[type=number]:focus {
            box-shadow: 0 0 12px #3b82f6cc;
        }

        button.buyBtn {
            margin-top: 20px;
            padding: 14px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 24px;
            border: none;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            color: white;
            cursor: pointer;
            box-shadow: 0 0 12px #2563ebcc;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        button.buyBtn:hover {
            background: linear-gradient(90deg, #1d4ed8, #2563eb);
            box-shadow: 0 0 25px #3b82f6dd;
        }

        #status {
            margin-top: 18px;
            font-weight: 600;
            min-height: 24px;
            font-size: 15px;
            color: #facc15; /* Ø²Ø±Ø¯ Ù…Ù„Ø§ÛŒÙ… */
            user-select: none;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .card {
                padding: 30px 15px;
            }
            input[type=number] {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<header>
    <button onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
</header>

<main>
    <div class="card">
        <h2>POOL Token Presale</h2>
        <p id="walletAddress">Wallet: Not connected</p>
        <p id="userBalance">Your POOL Balance: 0</p>
        <p id="contractBalance">Tokens Left in Presale: 0</p>
        <p id="rateInfo">Rate: Loading...</p>

        <input type="number" id="ethAmount" placeholder="ETH amount (â‰¥0.02)" min="0.02" step="0.001" />
        <br />
        <button class="buyBtn" onclick="buyTokens()">Buy Tokens</button>
        <p id="status"></p>
    </div>
</main>

<script>
    const contractAddress = "0x7a1Ed548e5407Ec09937e467A90ca2Bc72A943E1";
    const tokenAddress = "0xd8b10C6D44F0A37aeE038B75C59d72a0634840E7";

    const abi = [
        { "inputs": [{ "internalType": "address", "name": "tokenAddress", "type": "address" }], "stateMutability": "nonpayable", "type": "constructor" },
        { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "buyer", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amountETH", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "amountTokens", "type": "uint256" }], "name": "TokensPurchased", "type": "event" },
        { "inputs": [], "name": "buyTokens", "outputs": [], "stateMutability": "payable", "type": "function" },
        { "inputs": [], "name": "token", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "TOKENS_PER_ETHER", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }
    ];

    let provider, signer, presaleContract, tokenContract, userAddress;

    function shortenAddress(addr) {
        return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

    async function connectWallet() {
        if (window.ethereum) {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                document.getElementById("walletAddress").innerText = `Wallet: ${shortenAddress(userAddress)}`;
                const connectBtn = document.getElementById("connectBtn");
                connectBtn.innerText = "Connected";
                connectBtn.disabled = true;
                connectBtn.style.cursor = "default";

                presaleContract = new ethers.Contract(contractAddress, abi, signer);

                await loadBalances();
                await loadRate();

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        resetConnection();
                    } else {
                        userAddress = accounts[0];
                        document.getElementById("walletAddress").innerText = `Wallet: ${shortenAddress(userAddress)}`;
                        loadBalances();
                    }
                });
            } catch (error) {
                console.error(error);
                alert("Could not connect wallet.");
            }
        } else {
            alert("Please install MetaMask!");
        }
    }

    function resetConnection() {
        userAddress = null;
        document.getElementById("walletAddress").innerText = "Wallet: Not connected";
        document.getElementById("userBalance").innerText = "Your POOL Balance: 0";
        document.getElementById("contractBalance").innerText = "Tokens Left in Presale: 0";
        document.getElementById("rateInfo").innerText = "Rate: Loading...";
        const connectBtn = document.getElementById("connectBtn");
        connectBtn.innerText = "Connect Wallet";
        connectBtn.disabled = false;
        connectBtn.style.cursor = "pointer";
    }

    async function loadRate() {
        try {
            const tokensPerEther = await presaleContract.TOKENS_PER_ETHER();
            const decimals = await getTokenDecimals();
            const formattedRate = ethers.utils.formatUnits(tokensPerEther, decimals);
            document.getElementById("rateInfo").innerText =
                `Rate: 1 ETH = ${formattedRate} POOL`;
        } catch (err) {
            console.error(err);
            document.getElementById("rateInfo").innerText = "Rate: Error loading";
        }
    }

    async function getTokenDecimals() {
        const tokenAbi = [
            "function decimals() view returns (uint8)"
        ];
        tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);
        return await tokenContract.decimals();
    }

    async function loadBalances() {
        if (!userAddress) return;
        try {
            const tokenAbi = [
                "function balanceOf(address) view returns (uint256)",
                "function decimals() view returns (uint8)"
            ];
            tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);

            const decimals = await tokenContract.decimals();
            const userBal = await tokenContract.balanceOf(userAddress);
            document.getElementById("userBalance").innerText =
                `Your POOL Balance: ${ethers.utils.formatUnits(userBal, decimals)}`;

            const contractBal = await tokenContract.balanceOf(contractAddress);
            document.getElementById("contractBalance").innerText =
                `Tokens Left in Presale: ${ethers.utils.formatUnits(contractBal, decimals)}`;
        } catch (error) {
            console.error(error);
            document.getElementById("userBalance").innerText = "Your POOL Balance: Error";
            document.getElementById("contractBalance").innerText = "Tokens Left in Presale: Error";
        }
    }

    async function buyTokens() {
        if (!userAddress) {
            alert("Please connect your wallet first!");
            return;
        }
        const ethAmount = document.getElementById("ethAmount").value;
        if (!ethAmount || ethAmount < 0.02) {
            alert("Minimum purchase is 0.02 ETH");
            return;
        }
        try {
            document.getElementById("status").style.color = '#facc15'; // yellow
            document.getElementById("status").innerText = "Transaction sent. Waiting for confirmation...";
            const tx = await presaleContract.buyTokens({ value: ethers.utils.parseEther(ethAmount) });
            await tx.wait();
            document.getElementById("status").style.color = '#22c55e'; // green
            document.getElementById("status").innerText = "Purchase successful! ðŸŽ‰";
            await loadBalances();
        } catch (err) {
            console.error(err);
            document.getElementById("status").style.color = '#ef4444'; // red
            document.getElementById("status").innerText = "Transaction failed!";
        }
    }
</script>

</body>
</html>
